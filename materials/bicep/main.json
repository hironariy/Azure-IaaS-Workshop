{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "10078115278134650773"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "prod",
        "dev",
        "test"
      ],
      "metadata": {
        "description": "Environment name (prod, dev, test)"
      }
    },
    "workloadName": {
      "type": "string",
      "defaultValue": "blogapp",
      "metadata": {
        "description": "Workload name for naming convention"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Admin username for all VMs"
      }
    },
    "sshPublicKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH public key for VM authentication"
      }
    },
    "adminObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object ID of the admin user for Key Vault access"
      }
    },
    "deployBastion": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Azure Bastion (set to false to reduce costs during development)"
      }
    },
    "deployMonitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Monitoring resources (Log Analytics, DCR)"
      }
    },
    "deployKeyVault": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Key Vault for secrets management"
      }
    },
    "deployStorage": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Storage Account for static assets"
      }
    },
    "webVmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "VM size for Web tier"
      }
    },
    "appVmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "VM size for App tier"
      }
    },
    "dbVmSize": {
      "type": "string",
      "defaultValue": "Standard_B4ms",
      "metadata": {
        "description": "VM size for DB tier"
      }
    },
    "dbDataDiskSizeGB": {
      "type": "int",
      "defaultValue": 128,
      "metadata": {
        "description": "MongoDB data disk size in GB"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "defaultTags": {
      "Environment": "[parameters('environment')]",
      "Workload": "[parameters('workloadName')]",
      "Owner": "Workshop",
      "CostCenter": "Training",
      "ManagedBy": "Bicep"
    },
    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
    "vnetAddressPrefix": "10.0.0.0/16",
    "webSubnetPrefix": "10.0.1.0/24",
    "appSubnetPrefix": "10.0.2.0/24",
    "dbSubnetPrefix": "10.0.3.0/24",
    "bastionSubnetPrefix": "10.0.255.0/26"
  },
  "resources": [
    {
      "condition": "[parameters('deployMonitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-log-analytics",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "retentionInDays": {
            "value": 30
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6824841165440596128"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Log retention in days (30-730, or -1 for unlimited)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "workspaceName": "[format('log-{0}-{1}-{2}', parameters('workloadName'), parameters('environment'), parameters('location'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Log Analytics workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace"
              },
              "value": "[variables('workspaceName')]"
            },
            "customerId": {
              "type": "string",
              "metadata": {
                "description": "Workspace ID (GUID) for agent configuration"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2022-10-01').customerId]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('deployMonitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-dcr",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01'), null()), 'outputs'), 'workspaceId'), 'value'), '')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10683752925150389331"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Log Analytics workspace"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "dcrName": "[format('dcr-{0}-{1}', parameters('workloadName'), parameters('environment'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2023-03-11",
              "name": "[variables('dcrName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "kind": "Linux",
              "properties": {
                "description": "[format('Data Collection Rule for {0} workshop VMs', parameters('workloadName'))]",
                "dataSources": {
                  "syslog": [
                    {
                      "name": "syslogDataSource",
                      "streams": [
                        "Microsoft-Syslog"
                      ],
                      "facilityNames": [
                        "auth",
                        "authpriv",
                        "daemon",
                        "syslog",
                        "user"
                      ],
                      "logLevels": [
                        "Debug",
                        "Info",
                        "Notice",
                        "Warning",
                        "Error",
                        "Critical",
                        "Alert",
                        "Emergency"
                      ]
                    }
                  ],
                  "performanceCounters": [
                    {
                      "name": "perfCounterDataSource",
                      "streams": [
                        "Microsoft-Perf"
                      ],
                      "samplingFrequencyInSeconds": 60,
                      "counterSpecifiers": [
                        "Processor(*)\\% Processor Time",
                        "Processor(*)\\% User Time",
                        "Processor(*)\\% Idle Time",
                        "Memory(*)\\% Used Memory",
                        "Memory(*)\\Available MBytes Memory",
                        "Memory(*)\\Used Memory MBytes",
                        "LogicalDisk(*)\\% Used Space",
                        "LogicalDisk(*)\\Free Megabytes",
                        "LogicalDisk(*)\\Disk Reads/sec",
                        "LogicalDisk(*)\\Disk Writes/sec",
                        "Network(*)\\Total Bytes Transmitted",
                        "Network(*)\\Total Bytes Received",
                        "Network(*)\\Bytes Total/sec"
                      ]
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "name": "logAnalyticsDestination",
                      "workspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-Syslog"
                    ],
                    "destinations": [
                      "logAnalyticsDestination"
                    ],
                    "transformKql": "source",
                    "outputStream": "Microsoft-Syslog"
                  },
                  {
                    "streams": [
                      "Microsoft-Perf"
                    ],
                    "destinations": [
                      "logAnalyticsDestination"
                    ],
                    "transformKql": "source",
                    "outputStream": "Microsoft-Perf"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "dcrId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Data Collection Rule"
              },
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
            },
            "dcrName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Data Collection Rule"
              },
              "value": "[variables('dcrName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-nsg-web",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "bastionSubnetPrefix": {
            "value": "[variables('bastionSubnetPrefix')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12425004405698961863"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "bastionSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.255.0/26",
              "metadata": {
                "description": "CIDR of the Bastion subnet for SSH access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "nsgName": "[format('nsg-web-{0}', parameters('environment'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "web",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHTTPInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "description": "Allow HTTP traffic from Internet via Load Balancer"
                    }
                  },
                  {
                    "name": "AllowHTTPSInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "description": "Allow HTTPS traffic from Internet via Load Balancer"
                    }
                  },
                  {
                    "name": "AllowSSHFromBastion",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('bastionSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH only from Azure Bastion subnet - no public SSH access"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerProbe",
                    "properties": {
                      "priority": 300,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "description": "Required for Azure Load Balancer health probes"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Deny all other inbound traffic (defense in depth)"
                    }
                  },
                  {
                    "name": "AllowOutboundToAppTier",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3000",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "10.0.2.0/24",
                      "description": "Allow NGINX to forward requests to App tier (Express API)"
                    }
                  },
                  {
                    "name": "AllowOutboundToAzureServices",
                    "properties": {
                      "priority": 200,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureCloud",
                      "description": "Allow outbound to Azure services (monitoring, updates)"
                    }
                  },
                  {
                    "name": "AllowDNS",
                    "properties": {
                      "priority": 300,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "53",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow DNS resolution"
                    }
                  },
                  {
                    "name": "AllowNTP",
                    "properties": {
                      "priority": 310,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "123",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow NTP for time sync (critical for auth tokens)"
                    }
                  },
                  {
                    "name": "AllowHTTPOutbound",
                    "properties": {
                      "priority": 400,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTP for apt package updates"
                    }
                  },
                  {
                    "name": "AllowHTTPSOutbound",
                    "properties": {
                      "priority": 410,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTPS for secure package updates and npm"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Web tier NSG"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Web tier NSG"
              },
              "value": "[variables('nsgName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-nsg-app",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "webSubnetPrefix": {
            "value": "[variables('webSubnetPrefix')]"
          },
          "dbSubnetPrefix": {
            "value": "[variables('dbSubnetPrefix')]"
          },
          "bastionSubnetPrefix": {
            "value": "[variables('bastionSubnetPrefix')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5739670785509626289"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "webSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.1.0/24",
              "metadata": {
                "description": "CIDR of the Web tier subnet (source for API traffic)"
              }
            },
            "dbSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.3.0/24",
              "metadata": {
                "description": "CIDR of the DB tier subnet (destination for database connections)"
              }
            },
            "bastionSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.255.0/26",
              "metadata": {
                "description": "CIDR of the Bastion subnet for SSH access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "nsgName": "[format('nsg-app-{0}', parameters('environment'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "app",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAPIFromWebTier",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3000",
                      "sourceAddressPrefix": "[parameters('webSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow API traffic only from Web tier (NGINX reverse proxy)"
                    }
                  },
                  {
                    "name": "AllowSSHFromBastion",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('bastionSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH only from Azure Bastion subnet"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerProbe",
                    "properties": {
                      "priority": 300,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Azure Load Balancer health probes"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Deny all other inbound traffic - App tier is not publicly accessible"
                    }
                  },
                  {
                    "name": "AllowMongoDBToDBTier",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "27017",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "[parameters('dbSubnetPrefix')]",
                      "description": "Allow MongoDB connections to DB tier"
                    }
                  },
                  {
                    "name": "AllowOutboundToAzureServices",
                    "properties": {
                      "priority": 200,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureCloud",
                      "description": "Allow outbound to Azure services (Key Vault, Monitor, Storage)"
                    }
                  },
                  {
                    "name": "AllowDNS",
                    "properties": {
                      "priority": 300,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "53",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow DNS resolution"
                    }
                  },
                  {
                    "name": "AllowNTP",
                    "properties": {
                      "priority": 310,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "123",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow NTP (required for JWT token validation timing)"
                    }
                  },
                  {
                    "name": "AllowHTTPSToEntraID",
                    "properties": {
                      "priority": 400,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureActiveDirectory",
                      "description": "Allow HTTPS to Entra ID for JWKS token validation"
                    }
                  },
                  {
                    "name": "AllowHTTPSOutbound",
                    "properties": {
                      "priority": 410,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTPS for npm packages and external API calls"
                    }
                  },
                  {
                    "name": "AllowHTTPOutbound",
                    "properties": {
                      "priority": 420,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTP for apt package updates"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the App tier NSG"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App tier NSG"
              },
              "value": "[variables('nsgName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-nsg-db",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "appSubnetPrefix": {
            "value": "[variables('appSubnetPrefix')]"
          },
          "dbSubnetPrefix": {
            "value": "[variables('dbSubnetPrefix')]"
          },
          "bastionSubnetPrefix": {
            "value": "[variables('bastionSubnetPrefix')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12096026720307476487"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "appSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "CIDR of the App tier subnet (only allowed MongoDB client)"
              }
            },
            "dbSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.3.0/24",
              "metadata": {
                "description": "CIDR of the DB tier subnet (for replica set communication)"
              }
            },
            "bastionSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.255.0/26",
              "metadata": {
                "description": "CIDR of the Bastion subnet for SSH access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "nsgName": "[format('nsg-db-{0}', parameters('environment'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "db",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowMongoDBFromAppTier",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "27017",
                      "sourceAddressPrefix": "[parameters('appSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow MongoDB connections only from App tier (Express API)"
                    }
                  },
                  {
                    "name": "AllowMongoDBReplicaSet",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "27017",
                      "sourceAddressPrefix": "[parameters('dbSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow MongoDB replica set communication between DB VMs"
                    }
                  },
                  {
                    "name": "AllowSSHFromBastion",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('bastionSubnetPrefix')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH only from Azure Bastion for maintenance"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerProbe",
                    "properties": {
                      "priority": 300,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Azure platform health monitoring"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Deny all other inbound - DB tier has strictest access control"
                    }
                  },
                  {
                    "name": "AllowMongoDBReplicaSetOutbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "27017",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "[parameters('dbSubnetPrefix')]",
                      "description": "Allow MongoDB replica set communication (outbound to other DB VM)"
                    }
                  },
                  {
                    "name": "AllowOutboundToAzureServices",
                    "properties": {
                      "priority": 200,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureCloud",
                      "description": "Allow outbound to Azure (Storage for backups, Monitor for metrics)"
                    }
                  },
                  {
                    "name": "AllowOutboundToStorage",
                    "properties": {
                      "priority": 210,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Storage",
                      "description": "Allow outbound to Azure Storage (backup destination)"
                    }
                  },
                  {
                    "name": "AllowDNS",
                    "properties": {
                      "priority": 300,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "53",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow DNS resolution"
                    }
                  },
                  {
                    "name": "AllowNTP",
                    "properties": {
                      "priority": 310,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Udp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "123",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow NTP (critical for replica set clock sync)"
                    }
                  },
                  {
                    "name": "AllowHTTPOutbound",
                    "properties": {
                      "priority": 400,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTP for apt package updates"
                    }
                  },
                  {
                    "name": "AllowHTTPSOutbound",
                    "properties": {
                      "priority": 410,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow HTTPS for MongoDB package downloads"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the DB tier NSG"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "Name of the DB tier NSG"
              },
              "value": "[variables('nsgName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-vnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "webSubnetPrefix": {
            "value": "[variables('webSubnetPrefix')]"
          },
          "appSubnetPrefix": {
            "value": "[variables('appSubnetPrefix')]"
          },
          "dbSubnetPrefix": {
            "value": "[variables('dbSubnetPrefix')]"
          },
          "bastionSubnetPrefix": {
            "value": "[variables('bastionSubnetPrefix')]"
          },
          "webNsgId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-nsg-web'), '2025-04-01').outputs.nsgId.value]"
          },
          "appNsgId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-nsg-app'), '2025-04-01').outputs.nsgId.value]"
          },
          "dbNsgId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-nsg-db'), '2025-04-01').outputs.nsgId.value]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8469709004672643051"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources. Use the same region as your resource group."
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name for naming convention (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "VNet address space CIDR block"
              }
            },
            "webSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.1.0/24",
              "metadata": {
                "description": "Web tier subnet CIDR block"
              }
            },
            "appSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "App tier subnet CIDR block"
              }
            },
            "dbSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.3.0/24",
              "metadata": {
                "description": "DB tier subnet CIDR block"
              }
            },
            "bastionSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.255.0/26",
              "metadata": {
                "description": "Azure Bastion subnet CIDR block (minimum /26)"
              }
            },
            "webNsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of NSG for Web tier subnet"
              }
            },
            "appNsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of NSG for App tier subnet"
              }
            },
            "dbNsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of NSG for DB tier subnet"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}-{1}-{2}', parameters('workloadName'), parameters('environment'), parameters('location'))]",
            "webSubnetName": "[format('snet-web-{0}', parameters('environment'))]",
            "appSubnetName": "[format('snet-app-{0}', parameters('environment'))]",
            "dbSubnetName": "[format('snet-db-{0}', parameters('environment'))]",
            "bastionSubnetName": "AzureBastionSubnet",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('webSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('webSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[parameters('webNsgId')]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ],
                      "privateEndpointNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('appSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('appSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[parameters('appNsgId')]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ],
                      "privateEndpointNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('dbSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('dbSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[parameters('dbNsgId')]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ],
                      "privateEndpointNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('bastionSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('bastionSubnetPrefix')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Virtual Network"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Virtual Network"
              },
              "value": "[variables('vnetName')]"
            },
            "webSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Web tier subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-11-01').subnets[0].id]"
            },
            "appSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the App tier subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-11-01').subnets[1].id]"
            },
            "dbSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the DB tier subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-11-01').subnets[2].id]"
            },
            "bastionSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Bastion subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-11-01').subnets[3].id]"
            },
            "webSubnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Web tier subnet"
              },
              "value": "[variables('webSubnetName')]"
            },
            "appSubnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App tier subnet"
              },
              "value": "[variables('appSubnetName')]"
            },
            "dbSubnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the DB tier subnet"
              },
              "value": "[variables('dbSubnetName')]"
            },
            "webSubnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address prefix of the Web tier subnet"
              },
              "value": "[parameters('webSubnetPrefix')]"
            },
            "appSubnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address prefix of the App tier subnet"
              },
              "value": "[parameters('appSubnetPrefix')]"
            },
            "dbSubnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address prefix of the DB tier subnet"
              },
              "value": "[parameters('dbSubnetPrefix')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-nsg-app')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-nsg-db')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-nsg-web')]"
      ]
    },
    {
      "condition": "[parameters('deployBastion')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-bastion",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "bastionSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.bastionSubnetId.value]"
          },
          "bastionSku": {
            "value": "Basic"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2790187020448208416"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "bastionSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Bastion subnet (must be named AzureBastionSubnet)"
              }
            },
            "bastionSku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Developer"
              ],
              "metadata": {
                "description": "Bastion SKU - Basic is sufficient for workshop"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "bastionName": "[format('bastion-{0}-{1}', parameters('workloadName'), parameters('environment'))]",
            "publicIpName": "[format('pip-bastion-{0}-{1}', parameters('workloadName'), parameters('environment'))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4",
                "dnsSettings": {
                  "domainNameLabel": "[format('bastion-{0}-{1}-{2}', parameters('workloadName'), parameters('environment'), uniqueString(resourceGroup().id))]"
                }
              },
              "zones": [
                "1",
                "2",
                "3"
              ]
            },
            {
              "type": "Microsoft.Network/bastionHosts",
              "apiVersion": "2023-11-01",
              "name": "[variables('bastionName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "sku": {
                "name": "[parameters('bastionSku')]"
              },
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "IpConf",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('bastionSubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      }
                    }
                  }
                ],
                "disableCopyPaste": false,
                "enableFileCopy": "[equals(parameters('bastionSku'), 'Standard')]",
                "enableIpConnect": "[equals(parameters('bastionSku'), 'Standard')]",
                "enableShareableLink": "[equals(parameters('bastionSku'), 'Standard')]",
                "enableTunneling": "[equals(parameters('bastionSku'), 'Standard')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "bastionId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of Azure Bastion"
              },
              "value": "[resourceId('Microsoft.Network/bastionHosts', variables('bastionName'))]"
            },
            "bastionName": {
              "type": "string",
              "metadata": {
                "description": "Name of Azure Bastion"
              },
              "value": "[variables('bastionName')]"
            },
            "bastionPublicIp": {
              "type": "string",
              "metadata": {
                "description": "Public IP address of Azure Bastion"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-11-01').ipAddress]"
            },
            "bastionFqdn": {
              "type": "string",
              "metadata": {
                "description": "DNS name for Bastion"
              },
              "value": "[coalesce(tryGet(reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-11-01').dnsSettings, 'fqdn'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-load-balancer",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13227489126187721274"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "loadBalancerName": "[format('lbe-{0}-{1}', parameters('workloadName'), parameters('environment'))]",
            "publicIpName": "[format('pip-lb-{0}-{1}', parameters('workloadName'), parameters('environment'))]",
            "frontendName": "frontend-web",
            "backendPoolName": "backend-web",
            "healthProbeName": "probe-http",
            "lbRuleHttpName": "rule-http",
            "lbRuleHttpsName": "rule-https",
            "outboundRuleName": "outbound-web",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4",
                "dnsSettings": {
                  "domainNameLabel": "[format('{0}-{1}-{2}', parameters('workloadName'), parameters('environment'), uniqueString(resourceGroup().id))]"
                }
              },
              "zones": [
                "1",
                "2",
                "3"
              ]
            },
            {
              "type": "Microsoft.Network/loadBalancers",
              "apiVersion": "2023-11-01",
              "name": "[variables('loadBalancerName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "frontendIPConfigurations": [
                  {
                    "name": "[variables('frontendName')]",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      }
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "[variables('backendPoolName')]"
                  }
                ],
                "probes": [
                  {
                    "name": "[variables('healthProbeName')]",
                    "properties": {
                      "protocol": "Http",
                      "port": 80,
                      "requestPath": "/health",
                      "intervalInSeconds": 15,
                      "numberOfProbes": 2,
                      "probeThreshold": 1
                    }
                  }
                ],
                "loadBalancingRules": [
                  {
                    "name": "[variables('lbRuleHttpName')]",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerName'), variables('frontendName'))]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), variables('backendPoolName'))]"
                      },
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), variables('healthProbeName'))]"
                      },
                      "protocol": "Tcp",
                      "frontendPort": 80,
                      "backendPort": 80,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 4,
                      "loadDistribution": "Default",
                      "enableTcpReset": true,
                      "disableOutboundSnat": true
                    }
                  },
                  {
                    "name": "[variables('lbRuleHttpsName')]",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerName'), variables('frontendName'))]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), variables('backendPoolName'))]"
                      },
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), variables('healthProbeName'))]"
                      },
                      "protocol": "Tcp",
                      "frontendPort": 443,
                      "backendPort": 443,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 4,
                      "loadDistribution": "Default",
                      "enableTcpReset": true,
                      "disableOutboundSnat": true
                    }
                  }
                ],
                "outboundRules": [
                  {
                    "name": "[variables('outboundRuleName')]",
                    "properties": {
                      "frontendIPConfigurations": [
                        {
                          "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerName'), variables('frontendName'))]"
                        }
                      ],
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), variables('backendPoolName'))]"
                      },
                      "protocol": "All",
                      "allocatedOutboundPorts": 10000,
                      "enableTcpReset": true,
                      "idleTimeoutInMinutes": 4
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "loadBalancerId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Load Balancer"
              },
              "value": "[resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName'))]"
            },
            "loadBalancerName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Load Balancer"
              },
              "value": "[variables('loadBalancerName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Public IP address of the Load Balancer"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-11-01').ipAddress]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "FQDN of the Load Balancer"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-11-01').dnsSettings.fqdn]"
            },
            "backendPoolId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the backend address pool (for VM NIC association)"
              },
              "value": "[reference(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '2023-11-01').backendAddressPools[0].id]"
            },
            "backendPoolName": {
              "type": "string",
              "metadata": {
                "description": "Name of the backend address pool"
              },
              "value": "[variables('backendPoolName')]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('deployStorage')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "storageSku": {
            "value": "Standard_LRS"
          },
          "enableVersioning": {
            "value": false
          },
          "enableBlobSoftDelete": {
            "value": true
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9469222263178747129"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "storageSku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_ZRS",
                "Standard_GRS",
                "Standard_RAGRS"
              ],
              "metadata": {
                "description": "Storage account SKU (LRS for workshop, ZRS/GRS for production)"
              }
            },
            "enableVersioning": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable blob versioning"
              }
            },
            "enableBlobSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete for blobs"
              }
            },
            "softDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Soft delete retention in days"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "storageAccountName": "[format('st{0}{1}', parameters('workloadName'), uniqueString(resourceGroup().id))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "sku": {
                "name": "[parameters('storageSku')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "isVersioningEnabled": "[parameters('enableVersioning')]",
                "deleteRetentionPolicy": {
                  "enabled": "[parameters('enableBlobSoftDelete')]",
                  "days": "[parameters('softDeleteRetentionDays')]"
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": "[parameters('enableBlobSoftDelete')]",
                  "days": "[parameters('softDeleteRetentionDays')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'assets')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'uploads')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'backups')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Storage Account"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Storage Account"
              },
              "value": "[variables('storageAccountName')]"
            },
            "blobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Primary Blob endpoint URL"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "assetsContainerName": {
              "type": "string",
              "metadata": {
                "description": "Assets container name"
              },
              "value": "assets"
            },
            "uploadsContainerName": {
              "type": "string",
              "metadata": {
                "description": "Uploads container name"
              },
              "value": "uploads"
            },
            "backupsContainerName": {
              "type": "string",
              "metadata": {
                "description": "Backups container name"
              },
              "value": "backups"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-web-tier",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.webSubnetId.value]"
          },
          "loadBalancerBackendPoolId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-load-balancer'), '2025-04-01').outputs.backendPoolId.value]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "vmSize": {
            "value": "[parameters('webVmSize')]"
          },
          "enableMonitoring": {
            "value": "[parameters('deployMonitoring')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01'), null()), 'outputs'), 'workspaceId'), 'value'), '')]"
          },
          "dataCollectionRuleId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-dcr'), '2025-04-01'), null()), 'outputs'), 'dcrId'), 'value'), '')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8966518944081658841"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Web tier subnet"
              }
            },
            "loadBalancerBackendPoolId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Load Balancer backend pool"
              }
            },
            "adminUsername": {
              "type": "string",
              "defaultValue": "azureuser",
              "metadata": {
                "description": "Admin username for VMs"
              }
            },
            "sshPublicKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH public key for authentication"
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B2s",
              "metadata": {
                "description": "VM size for web tier"
              }
            },
            "enableMonitoring": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure Monitor Agent"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Log Analytics workspace"
              }
            },
            "dataCollectionRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Data Collection Rule"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "web",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
            "nginxInstallScript": "#!/bin/bash\nset -e\n\n# ==========================================================\n# Wait for dpkg/apt locks to be released\n# ==========================================================\n# Azure Linux Agent may be running unattended-upgrades on first boot\n# This can hold dpkg lock for 1-5 minutes\n# We wait up to 5 minutes for the lock to be released\n# ==========================================================\n\nwait_for_apt_lock() {\n  local timeout=300\n  local interval=10\n  local elapsed=0\n  \n  echo \"Checking for dpkg/apt locks...\"\n  \n  while true; do\n    # Check if any apt/dpkg processes are running\n    if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \\\n       ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1 && \\\n       ! fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then\n      echo \"All apt/dpkg locks are free, proceeding...\"\n      return 0\n    fi\n    \n    if [ $elapsed -ge $timeout ]; then\n      echo \"ERROR: Timeout waiting for apt/dpkg locks after ${timeout}s\"\n      return 1\n    fi\n    \n    echo \"apt/dpkg lock is held, waiting ${interval}s... (${elapsed}s elapsed)\"\n    sleep $interval\n    elapsed=$((elapsed + interval))\n  done\n}\n\n# Set non-interactive mode to prevent prompts during package installation\nexport DEBIAN_FRONTEND=noninteractive\n\n# Execute wait function (initial check to reduce log spam)\nwait_for_apt_lock\n\n# Update packages with lock timeout (backup protection against race conditions)\n# DPkg::Lock::Timeout waits up to 120 seconds if another process holds the lock\napt-get -o DPkg::Lock::Timeout=120 update\napt-get -o DPkg::Lock::Timeout=120 -y upgrade\n\n# Install NGINX\napt-get -o DPkg::Lock::Timeout=120 -y install nginx\n\n# Create health check endpoint\nmkdir -p /var/www/html\necho 'OK' > /var/www/html/health\n\n# Basic NGINX configuration for reverse proxy\n# Note: Full configuration will be deployed with application\ncat > /etc/nginx/sites-available/default << 'EOF'\nserver {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    root /var/www/html;\n    index index.html;\n\n    # Health check endpoint for Load Balancer\n    location /health {\n        access_log off;\n        return 200 'OK';\n        add_header Content-Type text/plain;\n    }\n\n    # Serve static files (React frontend)\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n\n    # Proxy API requests to App tier\n    # Note: Update APP_TIER_IP after deployment\n    location /api/ {\n        # Placeholder - update with actual App tier IP\n        proxy_pass http://10.0.2.4:3000/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\nEOF\n\n# Enable and restart NGINX\nsystemctl enable nginx\nsystemctl restart nginx\n\necho \"NGINX installation completed successfully\"\n"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-web-az1",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-web-az1-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "1"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "loadBalancerBackendPoolId": {
                    "value": "[parameters('loadBalancerBackendPoolId')]"
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('nginxInstallScript'))]"
                  },
                  "tags": {
                    "value": "[variables('allTags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-web-az2",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-web-az2-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "2"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "loadBalancerBackendPoolId": {
                    "value": "[parameters('loadBalancerBackendPoolId')]"
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('nginxInstallScript'))]"
                  },
                  "tags": {
                    "value": "[variables('allTags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "vmIds": {
              "type": "array",
              "metadata": {
                "description": "Resource IDs of Web tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az1'), '2025-04-01').outputs.vmId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az2'), '2025-04-01').outputs.vmId.value]"
              ]
            },
            "vmNames": {
              "type": "array",
              "metadata": {
                "description": "Names of Web tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az1'), '2025-04-01').outputs.vmName.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az2'), '2025-04-01').outputs.vmName.value]"
              ]
            },
            "privateIpAddresses": {
              "type": "array",
              "metadata": {
                "description": "Private IP addresses of Web tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az1'), '2025-04-01').outputs.privateIpAddress.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az2'), '2025-04-01').outputs.privateIpAddress.value]"
              ]
            },
            "principalIds": {
              "type": "array",
              "metadata": {
                "description": "Principal IDs of VM managed identities"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az1'), '2025-04-01').outputs.principalId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-web-az2'), '2025-04-01').outputs.principalId.value]"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-dcr')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-load-balancer')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-app-tier",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.appSubnetId.value]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "vmSize": {
            "value": "[parameters('appVmSize')]"
          },
          "enableMonitoring": {
            "value": "[parameters('deployMonitoring')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01'), null()), 'outputs'), 'workspaceId'), 'value'), '')]"
          },
          "dataCollectionRuleId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-dcr'), '2025-04-01'), null()), 'outputs'), 'dcrId'), 'value'), '')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16761350007461160802"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the App tier subnet"
              }
            },
            "adminUsername": {
              "type": "string",
              "defaultValue": "azureuser",
              "metadata": {
                "description": "Admin username for VMs"
              }
            },
            "sshPublicKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH public key for authentication"
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B2s",
              "metadata": {
                "description": "VM size for app tier"
              }
            },
            "enableMonitoring": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure Monitor Agent"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Log Analytics workspace"
              }
            },
            "dataCollectionRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Data Collection Rule"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "app",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
            "nodeInstallScript": "#!/bin/bash\nset -e\n\n# ==========================================================\n# Wait for dpkg/apt locks to be released\n# ==========================================================\n# Azure Linux Agent may be running unattended-upgrades on first boot\n# This can hold dpkg lock for 1-5 minutes\n# We wait up to 5 minutes for the lock to be released\n# ==========================================================\n\nwait_for_apt_lock() {\n  local timeout=300\n  local interval=10\n  local elapsed=0\n  \n  echo \"Checking for dpkg/apt locks...\"\n  \n  while true; do\n    # Check if any apt/dpkg processes are running\n    if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \\\n       ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1 && \\\n       ! fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then\n      echo \"All apt/dpkg locks are free, proceeding...\"\n      return 0\n    fi\n    \n    if [ $elapsed -ge $timeout ]; then\n      echo \"ERROR: Timeout waiting for apt/dpkg locks after ${timeout}s\"\n      return 1\n    fi\n    \n    echo \"apt/dpkg lock is held, waiting ${interval}s... (${elapsed}s elapsed)\"\n    sleep $interval\n    elapsed=$((elapsed + interval))\n  done\n}\n\n# Set non-interactive mode to prevent prompts during package installation\nexport DEBIAN_FRONTEND=noninteractive\n\n# Execute wait function (initial check to reduce log spam)\nwait_for_apt_lock\n\n# Update packages with lock timeout (backup protection against race conditions)\n# DPkg::Lock::Timeout waits up to 120 seconds if another process holds the lock\napt-get -o DPkg::Lock::Timeout=120 update\napt-get -o DPkg::Lock::Timeout=120 -y upgrade\n\n# Install prerequisites\napt-get -o DPkg::Lock::Timeout=120 -y install ca-certificates curl gnupg\n\n# Add NodeSource repository for Node.js 20 LTS\nmkdir -p /etc/apt/keyrings\n\n# Use --batch flag for non-interactive GPG operation (no TTY available in CustomScript)\n# Check if keyring already exists to make script idempotent (re-runnable)\nif [ ! -f /etc/apt/keyrings/nodesource.gpg ]; then\n  echo \"Downloading NodeSource GPG key...\"\n  curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --batch --dearmor -o /etc/apt/keyrings/nodesource.gpg\nelse\n  echo \"NodeSource GPG key already exists, skipping download\"\nfi\n\n# Add repository if not already present\nif [ ! -f /etc/apt/sources.list.d/nodesource.list ]; then\n  echo \"deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main\" | tee /etc/apt/sources.list.d/nodesource.list\nfi\n\n# Install Node.js 20 LTS\napt-get -o DPkg::Lock::Timeout=120 update\napt-get -o DPkg::Lock::Timeout=120 -y install nodejs\n\n# Verify installation\nnode --version\nnpm --version\n\n# Install PM2 globally (process manager for Node.js)\nnpm install -g pm2\n\n# Create application directory\nmkdir -p /opt/blogapp\nchown -R azureuser:azureuser /opt/blogapp\n\n# Create systemd service for PM2\npm2 startup systemd -u azureuser --hp /home/azureuser\n\n# Create a placeholder health check server\ncat > /opt/blogapp/health-server.js << 'EOF'\nconst http = require('http');\n\nconst server = http.createServer((req, res) => {\n  if (req.url === '/api/health' || req.url === '/health') {\n    res.writeHead(200, { 'Content-Type': 'application/json' });\n    res.end(JSON.stringify({ status: 'healthy', timestamp: new Date().toISOString() }));\n  } else {\n    res.writeHead(404);\n    res.end('Not Found');\n  }\n});\n\nconst PORT = process.env.PORT || 3000;\nserver.listen(PORT, () => {\n  console.log(`Health check server running on port ${PORT}`);\n});\nEOF\n\n# Start health check server with PM2 (temporary until app is deployed)\ncd /opt/blogapp\nsudo -u azureuser pm2 start health-server.js --name blogapp-health\nsudo -u azureuser pm2 save\n\necho \"Node.js installation completed successfully\"\n"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-app-az1",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-app-az1-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "1"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "loadBalancerBackendPoolId": {
                    "value": ""
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('nodeInstallScript'))]"
                  },
                  "tags": {
                    "value": "[variables('allTags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-app-az2",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-app-az2-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "2"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "loadBalancerBackendPoolId": {
                    "value": ""
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('nodeInstallScript'))]"
                  },
                  "tags": {
                    "value": "[variables('allTags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "vmIds": {
              "type": "array",
              "metadata": {
                "description": "Resource IDs of App tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az1'), '2025-04-01').outputs.vmId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az2'), '2025-04-01').outputs.vmId.value]"
              ]
            },
            "vmNames": {
              "type": "array",
              "metadata": {
                "description": "Names of App tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az1'), '2025-04-01').outputs.vmName.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az2'), '2025-04-01').outputs.vmName.value]"
              ]
            },
            "privateIpAddresses": {
              "type": "array",
              "metadata": {
                "description": "Private IP addresses of App tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az1'), '2025-04-01').outputs.privateIpAddress.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az2'), '2025-04-01').outputs.privateIpAddress.value]"
              ]
            },
            "principalIds": {
              "type": "array",
              "metadata": {
                "description": "Principal IDs of VM managed identities"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az1'), '2025-04-01').outputs.principalId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-app-az2'), '2025-04-01').outputs.principalId.value]"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-dcr')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-db-tier",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.dbSubnetId.value]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "vmSize": {
            "value": "[parameters('dbVmSize')]"
          },
          "dataDiskSizeGB": {
            "value": "[parameters('dbDataDiskSizeGB')]"
          },
          "enableMonitoring": {
            "value": "[parameters('deployMonitoring')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01'), null()), 'outputs'), 'workspaceId'), 'value'), '')]"
          },
          "dataCollectionRuleId": {
            "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-dcr'), '2025-04-01'), null()), 'outputs'), 'dcrId'), 'value'), '')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5482961546371674587"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the DB tier subnet"
              }
            },
            "adminUsername": {
              "type": "string",
              "defaultValue": "azureuser",
              "metadata": {
                "description": "Admin username for VMs"
              }
            },
            "sshPublicKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH public key for authentication"
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B4ms",
              "metadata": {
                "description": "VM size for database tier"
              }
            },
            "dataDiskSizeGB": {
              "type": "int",
              "defaultValue": 128,
              "metadata": {
                "description": "Data disk size in GB for MongoDB data"
              }
            },
            "enableMonitoring": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure Monitor Agent"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Log Analytics workspace"
              }
            },
            "dataCollectionRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of Data Collection Rule"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "Tier": "db",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
            "dataDisks": [
              {
                "sizeGB": "[parameters('dataDiskSizeGB')]",
                "type": "Premium_LRS",
                "caching": "None"
              }
            ],
            "mongoInstallScript": "#!/bin/bash\nset -e\n\n# ==========================================================\n# Wait for dpkg/apt locks to be released\n# ==========================================================\n# Azure Linux Agent may be running unattended-upgrades on first boot\n# This can hold dpkg lock for 1-5 minutes\n# We wait up to 5 minutes for the lock to be released\n# ==========================================================\n\nwait_for_apt_lock() {\n  local timeout=300\n  local interval=10\n  local elapsed=0\n  \n  echo \"Checking for dpkg/apt locks...\"\n  \n  while true; do\n    # Check if any apt/dpkg processes are running\n    if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \\\n       ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1 && \\\n       ! fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then\n      echo \"All apt/dpkg locks are free, proceeding...\"\n      return 0\n    fi\n    \n    if [ $elapsed -ge $timeout ]; then\n      echo \"ERROR: Timeout waiting for apt/dpkg locks after ${timeout}s\"\n      return 1\n    fi\n    \n    echo \"apt/dpkg lock is held, waiting ${interval}s... (${elapsed}s elapsed)\"\n    sleep $interval\n    elapsed=$((elapsed + interval))\n  done\n}\n\n# Set non-interactive mode to prevent prompts during package installation\nexport DEBIAN_FRONTEND=noninteractive\n\n# Execute wait function (initial check to reduce log spam)\nwait_for_apt_lock\n\n# Update packages with lock timeout (backup protection against race conditions)\n# DPkg::Lock::Timeout waits up to 120 seconds if another process holds the lock\napt-get -o DPkg::Lock::Timeout=120 update\napt-get -o DPkg::Lock::Timeout=120 -y upgrade\n\n# ==========================================================\n# Mount Data Disk\n# ==========================================================\n# Azure disk device names are NOT guaranteed (/dev/sdc may not always be the data disk)\n# The resource/temp disk is often /dev/sdc and is already mounted to /mnt\n# We need to find our Premium SSD data disk by:\n#   1. Looking for unpartitioned disks of the expected size\n#   2. Or by checking Azure metadata for LUN mappings\n# Our data disk is 128GB Premium SSD attached at LUN 0\n# ==========================================================\n\nMOUNT_POINT=\"/data/mongodb\"\nDATA_DISK=\"\"\nEXPECTED_SIZE_GB=128  # Must match dataDiskSizeGB parameter in Bicep\n\necho \"=== Identifying data disk ===\"\necho \"Looking for ${EXPECTED_SIZE_GB}GB disk...\"\n\n# List all disks for debugging\nlsblk -d -o NAME,SIZE,TYPE,MOUNTPOINT\n\n# Find the data disk by size (128GB = ~137GB in lsblk due to GB vs GiB)\n# Look for disks that are close to our expected size and not the OS disk\nfor disk in /dev/sd?; do\n  if [ -b \"$disk\" ]; then\n    DISK_NAME=$(basename \"$disk\")\n    # Get size in bytes\n    DISK_SIZE_BYTES=$(blockdev --getsize64 \"$disk\" 2>/dev/null || echo \"0\")\n    DISK_SIZE_GB=$((DISK_SIZE_BYTES / 1024 / 1024 / 1024))\n    \n    echo \"Checking $disk: ${DISK_SIZE_GB}GB\"\n    \n    # Check if this is approximately our expected size (within 10GB tolerance)\n    if [ $DISK_SIZE_GB -ge $((EXPECTED_SIZE_GB - 10)) ] && [ $DISK_SIZE_GB -le $((EXPECTED_SIZE_GB + 10)) ]; then\n      # Verify it's not already partitioned with a mounted partition\n      MOUNTED=$(lsblk -n -o MOUNTPOINT \"$disk\" 2>/dev/null | grep -v \"^$\" | head -1)\n      if [ -z \"$MOUNTED\" ]; then\n        # Check if any partition is mounted\n        PART_MOUNTED=$(lsblk -n -o MOUNTPOINT \"${disk}\"* 2>/dev/null | grep -v \"^$\" | head -1)\n        if [ -z \"$PART_MOUNTED\" ] || [ \"$PART_MOUNTED\" = \"$MOUNT_POINT\" ]; then\n          DATA_DISK=\"$disk\"\n          echo \"Found data disk: $DATA_DISK (${DISK_SIZE_GB}GB)\"\n          break\n        else\n          echo \"Disk $disk has partition mounted at $PART_MOUNTED, skipping\"\n        fi\n      else\n        echo \"Disk $disk is mounted at $MOUNTED, skipping\"\n      fi\n    fi\n  fi\ndone\n\n# Fallback: If not found by size, try to find any unpartitioned/unused disk\nif [ -z \"$DATA_DISK\" ]; then\n  echo \"Data disk not found by size, trying to find unused disk...\"\n  for disk in /dev/sda /dev/sdd /dev/sde; do\n    if [ -b \"$disk\" ]; then\n      # Check if disk has no partitions or is not mounted\n      PARTS=$(lsblk -n -o NAME \"$disk\" 2>/dev/null | wc -l)\n      MOUNTED=$(lsblk -n -o MOUNTPOINT \"$disk\" 2>/dev/null | grep -v \"^$\" | head -1)\n      if [ -z \"$MOUNTED\" ]; then\n        DATA_DISK=\"$disk\"\n        echo \"Found unused disk: $DATA_DISK\"\n        break\n      fi\n    fi\n  done\nfi\n\nif [ -z \"$DATA_DISK\" ]; then\n  echo \"ERROR: Could not identify the data disk\"\n  echo \"=== All block devices ===\"\n  lsblk\n  exit 1\nfi\n\necho \"Using data disk: $DATA_DISK\"\n\n# Create filesystem if not exists\nif ! blkid \"$DATA_DISK\" | grep -q \"TYPE=\"; then\n  echo \"Creating ext4 filesystem on $DATA_DISK\"\n  mkfs.ext4 -F \"$DATA_DISK\"\nfi\n\n# Create mount point\nmkdir -p \"$MOUNT_POINT\"\n\n# Add to fstab for persistent mount (but don't trigger systemd mount yet)\nif ! grep -q \"$DATA_DISK\" /etc/fstab; then\n  echo \"$DATA_DISK $MOUNT_POINT ext4 defaults,nofail 0 2\" >> /etc/fstab\n  # Reload systemd to recognize new fstab entry\n  systemctl daemon-reload\nfi\n\n# Wait a moment for any systemd mount activity to settle\nsleep 3\n\n# Mount the disk with comprehensive checks and retries\nmount_with_retry() {\n  local max_attempts=5\n  local attempt=1\n  \n  while [ $attempt -le $max_attempts ]; do\n    echo \"Mount attempt $attempt of $max_attempts...\"\n    \n    # Check if mount point is already mounted\n    if mountpoint -q \"$MOUNT_POINT\"; then\n      echo \"$MOUNT_POINT is already mounted\"\n      return 0\n    fi\n    \n    # Check if the disk is already mounted somewhere\n    if mount | grep -q \"^$DATA_DISK \"; then\n      CURRENT_MOUNT=$(mount | grep \"^$DATA_DISK \" | awk '{print $3}')\n      echo \"$DATA_DISK is already mounted at $CURRENT_MOUNT\"\n      if [ \"$CURRENT_MOUNT\" = \"$MOUNT_POINT\" ]; then\n        return 0\n      else\n        echo \"WARNING: Disk mounted at unexpected location, unmounting...\"\n        umount \"$DATA_DISK\" 2>/dev/null || true\n        sleep 2\n      fi\n    fi\n    \n    # Try to mount\n    echo \"Attempting to mount $DATA_DISK to $MOUNT_POINT\"\n    if mount \"$DATA_DISK\" \"$MOUNT_POINT\" 2>/dev/null; then\n      echo \"Mount successful\"\n      return 0\n    fi\n    \n    # Mount failed - check if systemd mounted it in the meantime\n    if mountpoint -q \"$MOUNT_POINT\"; then\n      echo \"Mount point became active (systemd mount succeeded)\"\n      return 0\n    fi\n    \n    echo \"Mount attempt $attempt failed, waiting before retry...\"\n    sleep 5\n    attempt=$((attempt + 1))\n  done\n  \n  echo \"ERROR: Failed to mount $DATA_DISK after $max_attempts attempts\"\n  return 1\n}\n\n# Execute mount with retry logic\nif ! mount_with_retry; then\n  echo \"=== Debug: Current mounts ===\"\n  mount | grep -E \"(sdc|mongodb)\" || echo \"No relevant mounts found\"\n  echo \"=== Debug: fstab content ===\"\n  grep -E \"(sdc|mongodb)\" /etc/fstab || echo \"No relevant fstab entries\"\n  echo \"=== Debug: Block devices ===\"\n  lsblk\n  exit 1\nfi\n\n# Verify mount succeeded\nif mountpoint -q \"$MOUNT_POINT\"; then\n  echo \"Verified: $MOUNT_POINT is mounted successfully\"\n  df -h \"$MOUNT_POINT\"\nelse\n  echo \"ERROR: $MOUNT_POINT is not mounted after all attempts\"\n  exit 1\nfi\n\n# Set ownership for mongodb user (will be created by package)\n# Done after mongodb installation\n\n# ==========================================================\n# Install MongoDB 7.0\n# ==========================================================\n# Import MongoDB public GPG key\napt-get -o DPkg::Lock::Timeout=120 -y install gnupg curl\n\n# Use --batch flag for non-interactive GPG operation (no TTY available in CustomScript)\n# Check if keyring already exists to make script idempotent (re-runnable)\nif [ ! -f /usr/share/keyrings/mongodb-server-7.0.gpg ]; then\n  echo \"Downloading MongoDB GPG key...\"\n  curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \\\n    gpg --batch -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor\nelse\n  echo \"MongoDB GPG key already exists, skipping download\"\nfi\n\n# Add MongoDB repository if not already present\nif [ ! -f /etc/apt/sources.list.d/mongodb-org-7.0.list ]; then\n  echo \"deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse\" | \\\n    tee /etc/apt/sources.list.d/mongodb-org-7.0.list\nfi\n\n# Create MongoDB data and log directories on data disk BEFORE installing MongoDB\n# This ensures the directories exist when the mongod service first starts\nmkdir -p /data/mongodb/db\nmkdir -p /data/mongodb/log\n\n# Update and install MongoDB\napt-get -o DPkg::Lock::Timeout=120 update\napt-get -o DPkg::Lock::Timeout=120 -y install mongodb-org\n\n# ==========================================================\n# Configure MongoDB for Replica Set\n# ==========================================================\n# Backup original config\ncp /etc/mongod.conf /etc/mongod.conf.bak\n\n# Set ownership (mongodb user created by package installation)\nchown -R mongodb:mongodb /data/mongodb\n\n# Configure MongoDB\n# Note: MongoDB 7.0+ no longer uses storage.journal.enabled (journaling is always on)\ncat > /etc/mongod.conf << 'EOF'\n# MongoDB 7.0 configuration file\n# Reference: https://www.mongodb.com/docs/manual/reference/configuration-options/\n\n# Where and how to store data\nstorage:\n  dbPath: /data/mongodb/db\n  wiredTiger:\n    engineConfig:\n      cacheSizeGB: 8  # Use 50% of RAM (16GB VM)\n\n# Where to write logging data\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /data/mongodb/log/mongod.log\n\n# Network interfaces\nnet:\n  port: 27017\n  bindIp: 0.0.0.0  # Listen on all interfaces (NSG controls access)\n\n# Process management\nprocessManagement:\n  timeZoneInfo: /usr/share/zoneinfo\n\n# Security (enable after replica set is initialized)\n# security:\n#   authorization: enabled\n#   keyFile: /etc/mongodb/keyfile\n\n# Replica set configuration\nreplication:\n  replSetName: blogapp-rs0\nEOF\n\n# Stop MongoDB if it was auto-started with default config\nsystemctl stop mongod 2>/dev/null || true\n\n# Ensure correct ownership after config change\nchown -R mongodb:mongodb /data/mongodb\n\n# Enable and start MongoDB with new configuration\nsystemctl daemon-reload\nsystemctl enable mongod\nsystemctl start mongod\n\n# Wait for MongoDB to start (give it more time on first boot)\necho \"Waiting for MongoDB to start...\"\nsleep 15\n\n# Verify MongoDB is running with retries\nfor i in 1 2 3; do\n  if systemctl is-active --quiet mongod; then\n    echo \"MongoDB installation completed successfully\"\n    # Show MongoDB version for verification\n    mongod --version | head -1\n    exit 0\n  fi\n  echo \"MongoDB not ready yet, waiting... (attempt $i/3)\"\n  sleep 10\ndone\n\n# If we get here, MongoDB failed to start\necho \"MongoDB failed to start after 3 attempts\"\necho \"=== MongoDB service status ===\"\nsystemctl status mongod --no-pager || true\necho \"=== Last 50 lines of MongoDB log ===\"\ntail -50 /data/mongodb/log/mongod.log 2>/dev/null || echo \"No log file found\"\nexit 1\n\n# ==========================================================\n# Post-Installation Notes\n# ==========================================================\n# To initialize the replica set, run the following on the PRIMARY node:\n#\n# mongosh --eval \"rs.initiate({\n#   _id: 'blogapp-rs0',\n#   members: [\n#     { _id: 0, host: 'vm-db-az1-prod:27017', priority: 2 },\n#     { _id: 1, host: 'vm-db-az2-prod:27017', priority: 1 }\n#   ]\n# })\"\n#\n# Check replica set status:\n# mongosh --eval \"rs.status()\"\n"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-db-az1",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-db-az1-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "1"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "dataDisks": {
                    "value": "[variables('dataDisks')]"
                  },
                  "loadBalancerBackendPoolId": {
                    "value": ""
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('mongoInstallScript'))]"
                  },
                  "tags": {
                    "value": "[union(variables('allTags'), createObject('Role', 'primary'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "deploy-vm-db-az2",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vmName": {
                    "value": "[format('vm-db-az2-{0}', parameters('environment'))]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "availabilityZone": {
                    "value": "2"
                  },
                  "subnetId": {
                    "value": "[parameters('subnetId')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "osDiskType": {
                    "value": "StandardSSD_LRS"
                  },
                  "osDiskSizeGB": {
                    "value": 30
                  },
                  "dataDisks": {
                    "value": "[variables('dataDisks')]"
                  },
                  "loadBalancerBackendPoolId": {
                    "value": ""
                  },
                  "enableMonitoring": {
                    "value": "[parameters('enableMonitoring')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "dataCollectionRuleId": {
                    "value": "[parameters('dataCollectionRuleId')]"
                  },
                  "customScriptContent": {
                    "value": "[base64(variables('mongoInstallScript'))]"
                  },
                  "tags": {
                    "value": "[union(variables('allTags'), createObject('Role', 'secondary'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17168036913246087060"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for all resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "metadata": {
                        "description": "VM size (e.g., Standard_B2s for web/app, Standard_B4ms for db)"
                      }
                    },
                    "availabilityZone": {
                      "type": "string",
                      "allowedValues": [
                        "1",
                        "2",
                        "3"
                      ],
                      "metadata": {
                        "description": "Availability Zone for the VM (1, 2, or 3)"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the subnet to attach the VM"
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "metadata": {
                        "description": "Admin username for the VM"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SSH public key for authentication (recommended over password)"
                      }
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ],
                      "metadata": {
                        "description": "OS disk type"
                      }
                    },
                    "osDiskSizeGB": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "OS disk size in GB"
                      }
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Data disk configurations (optional, for DB tier)"
                      }
                    },
                    "loadBalancerBackendPoolId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Load Balancer backend pool (optional, for web tier)"
                      }
                    },
                    "enableMonitoring": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable Azure Monitor Agent extension"
                      }
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Log Analytics workspace (required if enableMonitoring is true)"
                      }
                    },
                    "dataCollectionRuleId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of Data Collection Rule (required if enableMonitoring is true)"
                      }
                    },
                    "customScriptContent": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Custom script to run on VM startup (base64 encoded)"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to all resources"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('nic-{0}', parameters('vmName'))]",
                    "defaultTags": {
                      "ManagedBy": "Bicep"
                    },
                    "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-11-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "loadBalancerBackendAddressPools": "[if(not(empty(parameters('loadBalancerBackendPoolId'))), createArray(createObject('id', parameters('loadBalancerBackendPoolId'))), createArray())]"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-09-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "zones": [
                        "[parameters('availabilityZone')]"
                      ],
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "copy": [
                            {
                              "name": "dataDisks",
                              "count": "[length(parameters('dataDisks'))]",
                              "input": {
                                "name": "[format('datadisk-{0}-{1}', parameters('vmName'), copyIndex('dataDisks'))]",
                                "lun": "[copyIndex('dataDisks')]",
                                "createOption": "Empty",
                                "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].sizeGB]",
                                "caching": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'caching'), 'None')]",
                                "managedDisk": {
                                  "storageAccountType": "[coalesce(tryGet(parameters('dataDisks')[copyIndex('dataDisks')], 'type'), 'Premium_LRS')]"
                                },
                                "deleteOption": "Delete"
                              }
                            }
                          ],
                          "imageReference": "[variables('imageReference')]",
                          "osDisk": {
                            "name": "[format('osdisk-{0}', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            },
                            "diskSizeGB": "[parameters('osDiskSizeGB')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired"
                              }
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                              "properties": {
                                "primary": true,
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        },
                        "securityProfile": {
                          "securityType": "TrustedLaunch",
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitor",
                        "type": "AzureMonitorLinuxAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "settings": {
                          "authentication": {
                            "managedIdentity": {
                              "identifier-name": "mi_res_id",
                              "identifier-value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionRuleId'))))]",
                      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                      "apiVersion": "2022-06-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
                      "name": "configurationAccessEndpoint",
                      "properties": {
                        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('customScriptContent')))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScript')]",
                      "location": "[parameters('location')]",
                      "tags": "[variables('allTags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "script": "[parameters('customScriptContent')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AzureMonitorLinuxAgent')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vmId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Virtual Machine"
                      },
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "vmName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Virtual Machine"
                      },
                      "value": "[parameters('vmName')]"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "Private IP address of the VM"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the VM managed identity (for RBAC assignments)"
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2023-09-01', 'full').identity.principalId]"
                    },
                    "nicId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Network Interface"
                      },
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    },
                    "zone": {
                      "type": "string",
                      "metadata": {
                        "description": "Availability Zone of the VM"
                      },
                      "value": "[parameters('availabilityZone')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "vmIds": {
              "type": "array",
              "metadata": {
                "description": "Resource IDs of DB tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az1'), '2025-04-01').outputs.vmId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az2'), '2025-04-01').outputs.vmId.value]"
              ]
            },
            "vmNames": {
              "type": "array",
              "metadata": {
                "description": "Names of DB tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az1'), '2025-04-01').outputs.vmName.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az2'), '2025-04-01').outputs.vmName.value]"
              ]
            },
            "privateIpAddresses": {
              "type": "array",
              "metadata": {
                "description": "Private IP addresses of DB tier VMs"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az1'), '2025-04-01').outputs.privateIpAddress.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az2'), '2025-04-01').outputs.privateIpAddress.value]"
              ]
            },
            "principalIds": {
              "type": "array",
              "metadata": {
                "description": "Principal IDs of VM managed identities"
              },
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az1'), '2025-04-01').outputs.principalId.value]",
                "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az2'), '2025-04-01').outputs.principalId.value]"
              ]
            },
            "mongoConnectionString": {
              "type": "string",
              "metadata": {
                "description": "MongoDB connection string (after replica set initialization)"
              },
              "value": "[format('mongodb://{0}:27017,{1}:27017/blogapp?replicaSet=blogapp-rs0', reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az1'), '2025-04-01').outputs.privateIpAddress.value, reference(resourceId('Microsoft.Resources/deployments', 'deploy-vm-db-az2'), '2025-04-01').outputs.privateIpAddress.value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-dcr')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "condition": "[parameters('deployKeyVault')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-key-vault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          },
          "adminObjectId": {
            "value": "[parameters('adminObjectId')]"
          },
          "vmPrincipalIds": {
            "value": "[concat(reference(resourceId('Microsoft.Resources/deployments', 'deploy-web-tier'), '2025-04-01').outputs.principalIds.value, reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-tier'), '2025-04-01').outputs.principalIds.value, reference(resourceId('Microsoft.Resources/deployments', 'deploy-db-tier'), '2025-04-01').outputs.principalIds.value)]"
          },
          "enableSoftDelete": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11302943507701995217"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "prod",
              "allowedValues": [
                "prod",
                "dev",
                "test"
              ],
              "metadata": {
                "description": "Environment name (prod, dev, test)"
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "blogapp",
              "metadata": {
                "description": "Workload name for naming convention"
              }
            },
            "adminObjectId": {
              "type": "string",
              "metadata": {
                "description": "Object ID of the current user/service principal for initial access"
              }
            },
            "tenantId": {
              "type": "string",
              "defaultValue": "[subscription().tenantId]",
              "metadata": {
                "description": "Tenant ID for the Key Vault"
              }
            },
            "vmPrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Principal IDs of VMs that need secret access"
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete (recommended for production)"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 7,
              "maxValue": 90,
              "metadata": {
                "description": "Soft delete retention in days"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-{0}-{1}', parameters('workloadName'), uniqueString(resourceGroup().id))]",
            "defaultTags": {
              "Environment": "[parameters('environment')]",
              "Workload": "[parameters('workloadName')]",
              "ManagedBy": "Bicep"
            },
            "allTags": "[union(variables('defaultTags'), parameters('tags'))]",
            "keyVaultSecretsUserRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
            "keyVaultAdminRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
            "validVmPrincipalIds": "[filter(parameters('vmPrincipalIds'), lambda('id', and(not(empty(lambdaVariables('id'))), greaterOrEquals(length(lambdaVariables('id')), 36))))]",
            "isAdminObjectIdValid": "[and(not(empty(parameters('adminObjectId'))), greaterOrEquals(length(parameters('adminObjectId')), 36))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('allTags')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": "[parameters('enableSoftDelete')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "condition": "[variables('isAdminObjectIdValid')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), parameters('adminObjectId'), variables('keyVaultAdminRoleId'))]",
              "properties": {
                "roleDefinitionId": "[variables('keyVaultAdminRoleId')]",
                "principalId": "[parameters('adminObjectId')]",
                "principalType": "User"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "copy": {
                "name": "vmRoleAssignments",
                "count": "[length(variables('validVmPrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), variables('validVmPrincipalIds')[copyIndex()], variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[variables('keyVaultSecretsUserRoleId')]",
                "principalId": "[variables('validVmPrincipalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Key Vault"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              },
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-app-tier')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-db-tier')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-web-tier')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource Group name"
      },
      "value": "[resourceGroup().name]"
    },
    "loadBalancerPublicIp": {
      "type": "string",
      "metadata": {
        "description": "Load Balancer public IP address"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-load-balancer'), '2025-04-01').outputs.publicIpAddress.value]"
    },
    "loadBalancerFqdn": {
      "type": "string",
      "metadata": {
        "description": "Load Balancer FQDN"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-load-balancer'), '2025-04-01').outputs.fqdn.value]"
    },
    "webTierPrivateIps": {
      "type": "array",
      "metadata": {
        "description": "Web tier VM private IPs"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-web-tier'), '2025-04-01').outputs.privateIpAddresses.value]"
    },
    "appTierPrivateIps": {
      "type": "array",
      "metadata": {
        "description": "App tier VM private IPs"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-app-tier'), '2025-04-01').outputs.privateIpAddresses.value]"
    },
    "dbTierPrivateIps": {
      "type": "array",
      "metadata": {
        "description": "DB tier VM private IPs"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-db-tier'), '2025-04-01').outputs.privateIpAddresses.value]"
    },
    "mongoConnectionString": {
      "type": "string",
      "metadata": {
        "description": "MongoDB connection string"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-db-tier'), '2025-04-01').outputs.mongoConnectionString.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace ID"
      },
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01'), null()), 'outputs'), 'workspaceId'), 'value'), '')]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      },
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployKeyVault'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-key-vault'), '2025-04-01'), null()), 'outputs'), 'keyVaultUri'), 'value'), '')]"
    },
    "storageBlobEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Storage Account Blob Endpoint"
      },
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployStorage'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2025-04-01'), null()), 'outputs'), 'blobEndpoint'), 'value'), '')]"
    },
    "bastionName": {
      "type": "string",
      "metadata": {
        "description": "Azure Bastion name (for portal access)"
      },
      "value": "[coalesce(tryGet(tryGet(tryGet(if(parameters('deployBastion'), reference(resourceId('Microsoft.Resources/deployments', 'deploy-bastion'), '2025-04-01'), null()), 'outputs'), 'bastionName'), 'value'), '')]"
    }
  }
}