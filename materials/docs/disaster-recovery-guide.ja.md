# BCDR ガイド（Azure Backup + Azure Site Recovery）

このガイドでは、ワークショップの IaaS ベース 3 層アプリケーションに対して、**事業継続（Business Continuity）と災害復旧（Disaster Recovery）= BCDR** を実現するための実践的な進め方を説明します。

- **Azure Backup**: データと VM 状態を保護（ポイントインタイム復旧）
- **Azure Site Recovery（ASR）**: VM のリージョンフェールオーバーをオーケストレーション（災害対策）

## ワークショップ上の重要な注意

このアプリケーションには以下が含まれます。
- Web 層 VM（NGINX）
- App 層 VM（Node.js）
- DB 層 VM（MongoDB レプリカセット）

DB 層のフェールオーバーはステートレス層よりも繊細です。本ガイドでは **ワークショップに適した DR 演習** にフォーカスし、設計判断が必要な箇所を明示します。

---

## 1. DR 戦略を選ぶ（ワークショップ推奨）

### 選択肢 A（推奨）: 復旧は Backup、計算資源の DR は ASR

- **Azure Backup** を使ってポイントインタイムの VM 復元とデータ復旧を行う
- **ASR** を使って Web/App VM をペアリージョンへフェールオーバーする
- DB 層は慎重に扱う（後述「DB 層の考慮事項」参照）

### 選択肢 B（上級）: すべての層を ASR でリージョン DR

- Web/App/DB の VM を ASR でレプリケート
- DB のフェールオーバープランと、復旧シーケンスの明確化がより重要

**AWS との類比:** ASR は、インスタンスのレプリケーションとフェールオーバーをマネージドにしたもの（Route 53 のフェールオーバー + EC2 レプリケーションのパターンを組み合わせたようなイメージ）に近く、Azure Backup は AWS Backup に近い位置づけです。

---

## 2. Azure Backup: VM を保護する

### 2.1 Recovery Services vault を作成する

1. Azure portal で **Recovery Services vault** を作成します。
2. 同じサブスクリプション、かつ（通常は）ワークロードと同じリージョンに配置します。

### 2.2 VM バックアップを有効化する

1. Recovery Services vault を開きます。
2. **Backup** に移動し、Workload location は **Azure**、Workload は **Virtual machine** を選択します。
3. ワークショップの VM を選択し、**バックアップポリシー** を構成します。

**ワークショップの最低ライン:** 日次バックアップ + 短い保持期間。

### 2.3 リストアを実施する（演習）

- **Restore VM** を使って、復元ポイントから新しい VM を作成します。
- 次を確認します:
  - VM が起動する
  - アプリケーションサービスが起動する
  - 復元 VM がネットワーク（NSG/サブネット）に正しく参加できる

---

## 3. Azure Site Recovery: VM のリージョンフェールオーバー

### 3.1 前提条件

- レプリケーション管理用の **Recovery Services vault**
- **ターゲットリージョン**（多くの場合、Azure のペアリージョン）
- ターゲット側ネットワークの準備（VNet/サブネット）または ASR 設定時のマッピング

### 3.2 レプリケーションを有効化する

1. Recovery Services vault で **Site Recovery** を開きます。
2. Azure VM に対して **Enable replication** を選択します。
3. 次を選択します:
   - ソースリージョン/リソースグループ
   - ターゲットリージョン
   - ターゲットリソースグループ
   - ターゲット VNet/サブネットのマッピング
4. **レプリケーションポリシー** を作成/選択します。

### 3.3 Recovery Plan を作成する（推奨）

Recovery Plan により、起動順序を定義できます。
1. DB 層（含める場合）
2. App 層
3. Web 層

手動ステップも入れられますが、ワークショップでは最小限に留めるのがよいです。

### 3.4 テストフェールオーバー（安全な演習）

1. 分離ネットワークへ **Test failover** を実行します。
2. 次を確認します:
   - VM が期待どおりの順序で起動する
   - テストネットワーク内で web/app のエンドポイントが応答する
3. テストフェールオーバーのリソースをクリーンアップします。

### 3.5 計画フェールオーバー / 非計画フェールオーバー

- **Planned failover**: ソースリージョンが健全なときに利用（より安全でリスクが低い）
- **Unplanned failover**: 障害・停止シナリオで利用

---

## 4. DNS とトラフィック切り替え

フェールオーバーは、ユーザーが新リージョンへ到達できて初めて「完了」です。

ワークショップ環境では、切り替えは通常次の更新を意味します。
- Application Gateway の公開エンドポイント（DNS ラベル / Public IP）
- クライアント側のベース URL（ハードコードされている場合）

**推奨:** DNS ラベルや環境変数を明確にドキュメント化し、演習中に切り替えやすくします。

---

## 5. DB 層の考慮事項（MongoDB）

MongoDB レプリカセットはノード障害やゾーン冗長には適していますが、**リージョン DR** では計画が必要です。

ワークショップ向けの指針:
- DB VM を ASR でレプリケートする場合、Recovery Plan で DB を最初に起動するようにします。
- フェールオーバー後、レプリカセットの健全性と primary 選出を確認します。
- 単一リージョン前提のレプリカセット設計の場合、リージョン跨ぎは **上級拡張** として扱います。

よりシンプルな DR ストーリーにしたい場合:
- DB 層の復旧演習は Azure Backup のリストアに寄せる
- ASR のフェールオーバーはステートレス層（web/app）にフォーカスする

---

## 6. 「良い状態」の目安（受け入れチェック）

- **RPO が定義されている**: 許容できるデータ損失量
- **RTO が定義されている**: 許容できる停止時間
- バックアップが成功し、リストアが再現できる
- ASR のテストフェールオーバーが再現でき、検証されている
- トラフィック切り替え手順がドキュメント化され、ワークショップ時間内に実施できる

---

## 7. 次のステップ（任意）

- Bicep/CLI による Backup/ASR 設定の自動化
- 次のランブックを追加:
  - failover
  - failback
  - post-failover validation
- バックアップ失敗やレプリケーション健全性の Azure Monitor アラートを追加
